# ุจูููโุณุงุฒ ูุตุฑู ุชูฺฉู (Token Optimization)

## ๐ ุฎูุงุตู

ุงู ูุณุชูุฏุงุช ุชูุถุญ ูโุฏูุฏ ฺฉู ฺู ุชุบุฑุงุช ุจุฑุง ุฌููฺฏุฑ ุงุฒ ุฎุทุง **Rate Limit** (429) ุฏุฑ API ฺฉููุฏ ุงูุฌุงู ุดุฏู ุงุณุช. ูุดฺฉู ุงุตู ุงู ุจูุฏ ฺฉู ุฏุฑุฎูุงุณุชโูุง ุจุด ุงุฒ ุญุฏ ูุฌุงุฒ 450,000 ุชูฺฉู ุฏุฑ ุฏููู ูุตุฑู ูโฺฉุฑุฏูุฏ.

## ๐ ูุดฺฉู ุงุตู

ููฺฏุงู ฺฉู ุชุนุฏุงุฏ ุฒุงุฏ ูุงู ุชุบุฑ ูโฺฉุฑุฏ (ูุซูุงู 32 ูุงู)ุ ุชูุงู ูุญุชูุง ูุงูโูุง ุจู ููุฑุงู diff ุจู ฺฉููุฏ ุงุฑุณุงู ูโุดุฏ ฺฉู ุจุงุนุซ ูโุดุฏ:
- ุชุนุฏุงุฏ ุชูฺฉูโูุง ุงุฒ ุญุฏ ูุฌุงุฒ (450k/min) ุชุฌุงูุฒ ฺฉูุฏ
- ุฎุทุง `429 Rate Limit Error` ุฑุฎ ุฏูุฏ
- ูพุฑุฏุงุฒุด commitโูุง ูุชููู ุดูุฏ

## โ ุฑุงูฺฉุงุฑูุง ูพุงุฏูโุณุงุฒ ุดุฏู

### 1. ูุญุฏูุฏุช ุงูุฏุงุฒู ูุงูโูุง (File Size Limiting)

**ูุดฺฉู:** ูุงูโูุง ุจุฒุฑฺฏ (ูุซู ูุงูโูุง ุชุฑุฌูู JSON) ูโุชูุงููุฏ ูุฒุงุฑุงู ุชูฺฉู ูุตุฑู ฺฉููุฏ.

**ุฑุงูฺฉุงุฑ:**
- ูุงูโูุง ุจุฒุฑฺฏุชุฑ ุงุฒ 50KB ุจู ุตูุฑุช ุฎูุฏฺฉุงุฑ ฺฉูุชุงู ูโุดููุฏ
- ูุงูโูุง ุชุฑุฌูู (`/lang/*.json`) ููุท 5000 ฺฉุงุฑุงฺฉุชุฑ ุงูู ุงุฑุณุงู ูโุดููุฏ
- ฺฉูุชุงูโุณุงุฒ ุฏุฑ ููุทู ููุทู (ูุซูุงู ุขุฎุฑู ุฎุท ฺฉุงูู) ุงูุฌุงู ูโุดูุฏ

**ฺฉุฏ:**
```javascript
const MAX_FILE_SIZE = 50000; // 50KB default
const truncateContent = (content, maxSize) => {
    if (content.length <= maxSize) return content;
    // Truncate at reasonable point (newline)
    // ...
}
```

### 2. ููุชุฑ ููุดููุฏ ูุงูโูุง (Smart File Filtering)

**ูุดฺฉู:** ูพุฑุฏุงุฒุด ููู ูุงูโูุง ุญุช ุงฺฏุฑ ุบุฑุถุฑูุฑ ุจุงุดูุฏ.

**ุฑุงูฺฉุงุฑ:**
- ุงฺฏุฑ ุจุด ุงุฒ 20 ูุงู ุชุบุฑ ฺฉุฑุฏู ุจุงุดุฏุ ููุท ูููโุชุฑูโูุง ูพุฑุฏุงุฒุด ูโุดููุฏ
- ุงูููุชโุจูุฏ:
  1. **ุงูููุช ุจุงูุง:** ูุงูโูุง ฺฉุฏ (`.ts`, `.tsx`, `.js`, `.jsx`, `.py`, `.graphql`)
  2. **ุงูููุช ูุชูุณุท:** ูุงูโูุง ูพฺฉุฑุจูุฏ ู ุณุงุฑ ูุงูโูุง
  3. **ุงูููุช ูพุงู:** ูุงูโูุง ุชุฑุฌูู (`/lang/*.json`)

**ฺฉุฏ:**
```javascript
const MAX_FILES_TO_PROCESS = 20; // Default
const filterAndPrioritizeFiles = (filesFromA, filesFromB, diffText) => {
    // Prioritize source code files over translation files
    // ...
}
```

### 3. ุชุฎูู ู ูุญุฏูุฏุช ุชูฺฉู (Token Estimation & Limiting)

**ูุดฺฉู:** ููโุฏุงูุณุชู ูุจู ุงุฒ ุงุฑุณุงู ฺูุฏ ุชูฺฉู ูุตุฑู ูโุดูุฏ.

**ุฑุงูฺฉุงุฑ:**
- ูุจู ุงุฒ ุงุฑุณุงูุ ุชุนุฏุงุฏ ุชูฺฉู ุชุฎูู ุฒุฏู ูโุดูุฏ
- ุญุฏุงฺฉุซุฑ 400,000 ุชูฺฉู ุฏุฑ ูุฑ ุฏุฑุฎูุงุณุช (ุฒุฑ ุญุฏ 450k ุจุฑุง ุงุทููุงู)
- ุงฺฏุฑ ุชุฎูู ุงุฒ ุญุฏ ูุฌุงุฒ ุจุดุชุฑ ุจุงุดุฏุ ูุดุฏุงุฑ ููุงุด ุฏุงุฏู ูโุดูุฏ

**ฺฉุฏ:**
```javascript
const MAX_TOKENS_PER_REQUEST = 400000; // Safe limit below 450k
const estimateTokens = (text) => {
    // Rough estimate: ~3.5 chars per token
    return Math.ceil(text.length / 3.5);
}
```

### 4. Retry ุจุง Exponential Backoff

**ูุดฺฉู:** ุงฺฏุฑ ุฎุทุง rate limit ุฑุฎ ูโุฏุงุฏุ ุฏุฑุฎูุงุณุช ฺฉุงููุงู ุดฺฉุณุช ูโุฎูุฑุฏ.

**ุฑุงูฺฉุงุฑ:**
- ุฏุฑ ุตูุฑุช ุฎุทุง 429ุ ุจู ุตูุฑุช ุฎูุฏฺฉุงุฑ retry ูโุดูุฏ
- ุชุฃุฎุฑ ุจู retryโูุง ุจู ุตูุฑุช ุชุตุงุนุฏ ุงูุฒุงุด ูโุงุจุฏ
- ุญุฏุงฺฉุซุฑ 3 ุจุงุฑ ุชูุงุด ูุฌุฏุฏ
- ุงุฒ header `retry-after` API ุงุณุชูุงุฏู ูโฺฉูุฏ

**ฺฉุฏ:**
```javascript
const RETRY_MAX_ATTEMPTS = 3;
const RETRY_BASE_DELAY_MS = 60000; // 1 minute

// Exponential backoff: delay * (2 ^ retryAttempt)
const backoffDelay = delayMs * Math.pow(2, retryAttempt);
```

### 5. ููุชุฑ ูุงูโูุง ุบุฑุถุฑูุฑ

**ูุดฺฉู:** ูุงูโูุง buildุ node_modules ู ุบุฑู ูุฒ ูพุฑุฏุงุฒุด ูโุดุฏูุฏ.

**ุฑุงูฺฉุงุฑ:**
- ูุงูโูุง `node_modules/`ุ `dist/`ุ `build/` ู `.git/` ููุชุฑ ูโุดููุฏ
- ูุงูโูุง ุชุฑุฌูู ุจู ุตูุฑุช ุฎุงุต ูุฏุฑุช ูโุดููุฏ

**ฺฉุฏ:**
```javascript
const shouldFilterFile = (filePath, content) => {
    if (filePath.includes('node_modules/') || 
        filePath.includes('dist/') || 
        filePath.includes('build/') ||
        filePath.includes('.git/')) {
        return true;
    }
    // ...
}
```

## โ๏ธ ุชูุธูุงุช ูุงุจู ุชูุธู

ุชูุงู ุงู ูุญุฏูุฏุชโูุง ุงุฒ ุทุฑู ูุชุบุฑูุง ูุญุท ูุงุจู ุชูุธู ูุณุชูุฏ:

| ูุชุบุฑ | ูพุดโูุฑุถ | ุชูุถุญ |
|-------|---------|-------|
| `MAX_TOKENS_PER_REQUEST` | 400000 | ุญุฏุงฺฉุซุฑ ุชูฺฉู ุฏุฑ ูุฑ ุฏุฑุฎูุงุณุช |
| `MAX_FILE_SIZE` | 50000 | ุญุฏุงฺฉุซุฑ ุงูุฏุงุฒู ูุงู (ฺฉุงุฑุงฺฉุชุฑ) |
| `MAX_FILES_TO_PROCESS` | 20 | ุญุฏุงฺฉุซุฑ ุชุนุฏุงุฏ ูุงู ุฏุฑ ูุฑ ุฏุฑุฎูุงุณุช |
| `RETRY_MAX_ATTEMPTS` | 3 | ุชุนุฏุงุฏ ุชูุงุดโูุง ูุฌุฏุฏ |
| `RETRY_BASE_DELAY_MS` | 60000 | ุชุฃุฎุฑ ูพุงู ุจุฑุง retry (ููโุซุงูู) |

### ูุซุงู ุชูุธูุงุช ุฏุฑ `.env`:

```bash
# ุจุฑุง commitโูุง ุจุฒุฑฺฏุ ุชุนุฏุงุฏ ูุงูโูุง ุฑุง ฺฉุงูุด ุฏูุฏ
MAX_FILES_TO_PROCESS=15

# ุงฺฏุฑ ูููุฒ ุฎุทุง ูโฺฏุฑุฏุ ุชูฺฉู ุฑุง ุจุดุชุฑ ฺฉุงูุด ุฏูุฏ
MAX_TOKENS_PER_REQUEST=350000

# ุจุฑุง ูุงูโูุง ฺฉูฺฺฉุชุฑุ ุงูุฏุงุฒู ุฑุง ฺฉุงูุด ุฏูุฏ
MAX_FILE_SIZE=30000
```

## ๐ ูุชุงุฌ

ูพุณ ุงุฒ ุงุนูุงู ุงู ุชุบุฑุงุช:

โ **ูุงูโูุง ุจุฒุฑฺฏ ุจู ุตูุฑุช ุฎูุฏฺฉุงุฑ ฺฉูุชุงู ูโุดููุฏ**
- ูุงูโูุง ุชุฑุฌูู ููุท ููููู ฺฉูฺฺฉ ุงุฑุณุงู ูโุดููุฏ
- ูุงูโูุง ุจุฒุฑฺฏุชุฑ ุงุฒ 50KB ฺฉูุชุงู ูโุดููุฏ

โ **ุฏุฑ ุตูุฑุช ุฎุทุง rate limitุ retry ุฎูุฏฺฉุงุฑ ุงูุฌุงู ูโุดูุฏ**
- ุชุฃุฎุฑ ููุดููุฏุงูู ุจุง exponential backoff
- ุงุณุชูุงุฏู ุงุฒ `retry-after` header ุงุฒ API

โ **ููุท ูููโุชุฑู ูุงูโูุง ูพุฑุฏุงุฒุด ูโุดููุฏ**
- ุงูููุช ุจุง ูุงูโูุง ฺฉุฏ ุงุณุช
- ูุงูโูุง ุชุฑุฌูู ุฏุฑ ุงูููุช ูพุงู

โ **ุชุนุฏุงุฏ ุชูฺฉู ูุจู ุงุฒ ุงุฑุณุงู ฺฉูุชุฑู ูโุดูุฏ**
- ุชุฎูู ุฏูู ูุจู ุงุฒ ุงุฑุณุงู
- ูุดุฏุงุฑ ุฏุฑ ุตูุฑุช ูุฒุฏฺฉ ุดุฏู ุจู ุญุฏ ูุฌุงุฒ

## ๐ง ูุญูู ุงุณุชูุงุฏู

1. **ุชูุธูุงุช ูพุดโูุฑุถ:** ุจุฏูู ุชุบุฑุ ฺฉุฏ ุจุง ุชูุธูุงุช ูพุดโูุฑุถ ฺฉุงุฑ ูโฺฉูุฏ
2. **ุชูุธูุงุช ุณูุงุฑุด:** ุฏุฑ ุตูุฑุช ูุงุฒุ ูุชุบุฑูุง ูุญุท ุฑุง ุฏุฑ `.env` ุชูุธู ฺฉูุฏ
3. **ูุงูุชูุฑูฺฏ:** ูุงฺฏโูุง ุชุฎูู ุชูฺฉู ุฑุง ููุงุด ูโุฏููุฏ

## ๐ ูุซุงู ูุงฺฏ

```
๐ Estimated token usage: ~125000 tokens
๐ Selected 20 files for processing (skipped 12 files)
โ๏ธ Estimated tokens (380000) is within safe limit (400000)
```

## ๐จ ูฺฉุงุช ููู

1. **ูุงูโูุง ุชุฑุฌูู:** ุงฺฏุฑ ุชุบุฑุงุช ููู ุฏุฑ ูุงูโูุง ุชุฑุฌูู ุฏุงุฑุฏุ ููฺฉู ุงุณุช ูุงุฒ ุจุงุดุฏ `MAX_FILES_TO_PROCESS` ุฑุง ุงูุฒุงุด ุฏูุฏ
2. **Commitโูุง ุจุฒุฑฺฏ:** ุจุฑุง commitโูุง ุจุณุงุฑ ุจุฒุฑฺฏ (50+ ูุงู)ุ ููฺฉู ุงุณุช ูุงุฒ ุจู ูพุฑุฏุงุฒุด ุฏุณุชูโุง (batch processing) ุจุงุดุฏ
3. **Rate Limit:** ุงฺฏุฑ ูููุฒ ุฎุทุง ูโฺฏุฑุฏุ `MAX_TOKENS_PER_REQUEST` ุฑุง ฺฉุงูุด ุฏูุฏ

## ๐ ุจูุจูุฏูุง ุขูุฏู

- [ ] ูพุฑุฏุงุฒุด ุฏุณุชูโุง (batch processing) ุจุฑุง commitโูุง ุจุณุงุฑ ุจุฒุฑฺฏ
- [ ] ุงุณุชูุงุฏู ุงุฒ tokenizer ุฏููโุชุฑ ุจุฑุง ุชุฎูู ุชูฺฉู
- [ ] ฺฉุด ฺฉุฑุฏู ูุชุงุฌ ุจุฑุง ูุงูโูุง ูุดุงุจู
- [ ] ูพุดุชุจุงู ุงุฒ ูุงูโูุง ุจุงูุฑ

---

**ุชุงุฑุฎ ุงุฌุงุฏ:** 2025-12-10  
**ูุณุฎู:** 1.0.0

