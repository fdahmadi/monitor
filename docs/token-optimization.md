# ุจูููโุณุงุฒ ูุตุฑู ุชูฺฉู (Token Optimization)

## ๐ ุฎูุงุตู

ุงู ูุณุชูุฏุงุช ุชูุถุญ ูโุฏูุฏ ฺฉู ฺู ุชุบุฑุงุช ุจุฑุง ุฌููฺฏุฑ ุงุฒ ุฎุทุงูุง **Rate Limit** (429) ู **Invalid Request** (400) ุฏุฑ API ฺฉููุฏ ุงูุฌุงู ุดุฏู ุงุณุช. ูุดฺฉูุงุช ุงุตู:
- ุฏุฑุฎูุงุณุชโูุง ุจุด ุงุฒ ุญุฏ ูุฌุงุฒ 450,000 ุชูฺฉู ุฏุฑ ุฏููู ูุตุฑู ูโฺฉุฑุฏูุฏ
- Promptโูุง ุงุฒ ุญุฏ ูุฌุงุฒ 200,000 ุชูฺฉู API ุชุฌุงูุฒ ูโฺฉุฑุฏูุฏ

## ๐ ูุดฺฉู ุงุตู

ููฺฏุงู ฺฉู ุชุนุฏุงุฏ ุฒุงุฏ ูุงู ุชุบุฑ ูโฺฉุฑุฏ (ูุซูุงู 32 ูุงู)ุ ุชูุงู ูุญุชูุง ูุงูโูุง ุจู ููุฑุงู diff ุจู ฺฉููุฏ ุงุฑุณุงู ูโุดุฏ ฺฉู ุจุงุนุซ ูโุดุฏ:
- ุชุนุฏุงุฏ ุชูฺฉูโูุง ุงุฒ ุญุฏ ูุฌุงุฒ (450k/min) ุชุฌุงูุฒ ฺฉูุฏ โ ุฎุทุง `429 Rate Limit Error`
- Prompt ุงุฒ ุญุฏ ูุฌุงุฒ 200k ุชูฺฉู API ุชุฌุงูุฒ ฺฉูุฏ โ ุฎุทุง `400 Invalid Request Error`
- ูพุฑุฏุงุฒุด commitโูุง ูุชููู ุดูุฏ

## ๐ ุชุบุฑุงุช ูุณุฎู 2.0.0

### ุจูุจูุฏูุง ุฌุฏุฏ:
- โ ฺฉุงูุด ูุญุฏูุฏุชโูุง ุจุฑุง ุฑุนุงุช API hard limit (200k tokens)
- โ ููุชุฑ ูุงูโูุง ุฒุจุงู **ูุจู ุงุฒ ุฎูุงูุฏู** (16 ูุงู โ 2 ูุงู)
- โ ุญุฐู ูุงูโูุง auto-generated (`/generated/`, `*.generated.ts`)
- โ ฺฉูุชุงูโุณุงุฒ diffโูุง ุจุฒุฑฺฏ (>500KB)
- โ ุจุฑุฑุณ ุฏููโุชุฑ ุจุฑุง API hard limit

### ุชูุธูุงุช ุฌุฏุฏ ูพุดโูุฑุถ:
- `MAX_TOKENS_PER_REQUEST`: 180k (ุฒุฑ ุญุฏ 200k API)
- `MAX_FILE_SIZE`: 30KB (ฺฉุงูุด ุงุฒ 50KB)
- `MAX_FILES_TO_PROCESS`: 10 (ฺฉุงูุด ุงุฒ 20)
- `MAX_DIFF_SIZE`: 500KB (ุฌุฏุฏ)

## โ ุฑุงูฺฉุงุฑูุง ูพุงุฏูโุณุงุฒ ุดุฏู

### 1. ูุญุฏูุฏุช ุงูุฏุงุฒู ูุงูโูุง (File Size Limiting)

**ูุดฺฉู:** ูุงูโูุง ุจุฒุฑฺฏ (ูุซู ูุงูโูุง ุชุฑุฌูู JSON) ูโุชูุงููุฏ ูุฒุงุฑุงู ุชูฺฉู ูุตุฑู ฺฉููุฏ.

**ุฑุงูฺฉุงุฑ:**
- ูุงูโูุง ุจุฒุฑฺฏุชุฑ ุงุฒ 30KB ุจู ุตูุฑุช ุฎูุฏฺฉุงุฑ ฺฉูุชุงู ูโุดููุฏ
- ูุงูโูุง ุชุฑุฌูู (`/lang/*.json`) ููุท 5000 ฺฉุงุฑุงฺฉุชุฑ ุงูู ุงุฑุณุงู ูโุดููุฏ
- ฺฉูุชุงูโุณุงุฒ ุฏุฑ ููุทู ููุทู (ูุซูุงู ุขุฎุฑู ุฎุท ฺฉุงูู) ุงูุฌุงู ูโุดูุฏ
- Diffโูุง ุจุฒุฑฺฏุชุฑ ุงุฒ 500KB ฺฉูุชุงู ูโุดููุฏ

**ฺฉุฏ:**
```javascript
const MAX_FILE_SIZE = 30000; // 30KB default
const MAX_DIFF_SIZE = 500000; // 500KB default
const truncateContent = (content, maxSize) => {
    if (content.length <= maxSize) return content;
    // Truncate at reasonable point (newline)
    // ...
}
```

### 2. ููุชุฑ ููุดููุฏ ูุงูโูุง (Smart File Filtering)

**ูุดฺฉู:** ูพุฑุฏุงุฒุด ููู ูุงูโูุง ุญุช ุงฺฏุฑ ุบุฑุถุฑูุฑ ุจุงุดูุฏ.

**ุฑุงูฺฉุงุฑ:**
- ูุงูโูุง ุฒุจุงู **ูุจู ุงุฒ ุฎูุงูุฏู** ููุชุฑ ูโุดููุฏ (ููุท ฺฉ ููููู ุงุฒ ูุฑ category)
- ุงฺฏุฑ ุจุด ุงุฒ 10 ูุงู ุชุบุฑ ฺฉุฑุฏู ุจุงุดุฏุ ููุท ูููโุชุฑูโูุง ูพุฑุฏุงุฒุด ูโุดููุฏ
- ูุงูโูุง auto-generated (`/generated/`, `*.generated.ts`) ฺฉุงููุงู ุญุฐู ูโุดููุฏ
- ุงูููุชโุจูุฏ:
  1. **ุงูููุช ุจุงูุง:** ูุงูโูุง ฺฉุฏ (`.ts`, `.tsx`, `.js`, `.jsx`, `.py`, `.graphql`)
  2. **ุงูููุช ูุชูุณุท:** ูุงูโูุง ูพฺฉุฑุจูุฏ ู ุณุงุฑ ูุงูโูุง
  3. **ุงูููุช ูพุงู:** ูุงูโูุง ุชุฑุฌูู (`/lang/*.json`)

**ฺฉุฏ:**
```javascript
const MAX_FILES_TO_PROCESS = 10; // Default
// Filter translation files BEFORE reading
const filterTranslationFilesBeforeReading = (filesMap) => {
    // Keep only 1 sample per category (front/back)
    // ...
}
const filterAndPrioritizeFiles = (filesFromA, filesFromB, diffText) => {
    // Prioritize source code files over translation files
    // ...
}
```

### 3. ุชุฎูู ู ูุญุฏูุฏุช ุชูฺฉู (Token Estimation & Limiting)

**ูุดฺฉู:** ููโุฏุงูุณุชู ูุจู ุงุฒ ุงุฑุณุงู ฺูุฏ ุชูฺฉู ูุตุฑู ูโุดูุฏ.

**ุฑุงูฺฉุงุฑ:**
- ูุจู ุงุฒ ุงุฑุณุงูุ ุชุนุฏุงุฏ ุชูฺฉู ุชุฎูู ุฒุฏู ูโุดูุฏ
- ุญุฏุงฺฉุซุฑ 180,000 ุชูฺฉู ุฏุฑ ูุฑ ุฏุฑุฎูุงุณุช (ุฒุฑ ุญุฏ 200k API ุจุฑุง ุงุทููุงู)
- ุงฺฏุฑ ุชุฎูู ุงุฒ 190k ุจุดุชุฑ ุจุงุดุฏุ ุฎุทุง ูโุฏูุฏ (ูุจู ุงุฒ ุงุฑุณุงู ุจู API)
- ุจุฑุฑุณ ุฏูู ุจุฑุง API hard limit (200k tokens)

**ฺฉุฏ:**
```javascript
const MAX_TOKENS_PER_REQUEST = 180000; // Safe limit below 200k API hard limit
if (totalEstimatedTokens > 190000) {
    throw new Error('Too close to API hard limit (200k)');
}
const estimateTokens = (text) => {
    // Rough estimate: ~3.5 chars per token
    return Math.ceil(text.length / 3.5);
}
```

### 4. Retry ุจุง Exponential Backoff

**ูุดฺฉู:** ุงฺฏุฑ ุฎุทุง rate limit ุฑุฎ ูโุฏุงุฏุ ุฏุฑุฎูุงุณุช ฺฉุงููุงู ุดฺฉุณุช ูโุฎูุฑุฏ.

**ุฑุงูฺฉุงุฑ:**
- ุฏุฑ ุตูุฑุช ุฎุทุง 429ุ ุจู ุตูุฑุช ุฎูุฏฺฉุงุฑ retry ูโุดูุฏ
- ุชุฃุฎุฑ ุจู retryโูุง ุจู ุตูุฑุช ุชุตุงุนุฏ ุงูุฒุงุด ูโุงุจุฏ
- ุญุฏุงฺฉุซุฑ 3 ุจุงุฑ ุชูุงุด ูุฌุฏุฏ
- ุงุฒ header `retry-after` API ุงุณุชูุงุฏู ูโฺฉูุฏ

**ฺฉุฏ:**
```javascript
const RETRY_MAX_ATTEMPTS = 3;
const RETRY_BASE_DELAY_MS = 60000; // 1 minute

// Exponential backoff: delay * (2 ^ retryAttempt)
const backoffDelay = delayMs * Math.pow(2, retryAttempt);
```

### 5. ููุชุฑ ูุงูโูุง ุฒุจุงู ูุจู ุงุฒ ุฎูุงูุฏู

**ูุดฺฉู:** ูุงูโูุง ุฒุจุงู (18+ ูุงู) ููู ุฎูุงูุฏู ูโุดุฏูุฏ ู ุชูฺฉู ุฒุงุฏ ูุตุฑู ูโฺฉุฑุฏูุฏ.

**ุฑุงูฺฉุงุฑ:**
- ูุงูโูุง ุฒุจุงู **ูุจู ุงุฒ ุฎูุงูุฏู ุงุฒ ุฏุณฺฉ** ููุชุฑ ูโุดููุฏ
- ููุท ฺฉ ููููู ุงุฒ ูุฑ category (front/back) ุฎูุงูุฏู ูโุดูุฏ
- ุงูููุช ุจุง `en.json` ุงุณุชุ ุฏุฑ ุบุฑ ุงู ุตูุฑุช ุจู ุชุฑุชุจ ุงููุจุง
- ุจูู ูุงูโูุง ุฒุจุงู ููุชุฑ ูโุดููุฏ ู ุฏุฑ PR description ุชูุถุญ ุฏุงุฏู ูโุดูุฏ

**ฺฉุฏ:**
```javascript
export const filterTranslationFilesBeforeReading = (filesMap) => {
    // Filter translation files BEFORE reading from disk
    // Keep only 1 sample per category (front/back)
    // ...
}
```

**ูุชุฌู:**
- 18 ูุงู ุฒุจุงู โ 2 ูุงู (16 ูุงู ููุชุฑ ุดุฏู)
- ฺฉุงูุด ูุงุจู ุชูุฌู ูุตุฑู ุชูฺฉู

### 6. ฺฉูุชุงูโุณุงุฒ Diff

**ูุดฺฉู:** Diffโูุง ุจุฒุฑฺฏ ูโุชูุงููุฏ ูุฒุงุฑุงู ุชูฺฉู ูุตุฑู ฺฉููุฏ.

**ุฑุงูฺฉุงุฑ:**
- Diffโูุง ุจุฒุฑฺฏุชุฑ ุงุฒ 500KB ฺฉูุชุงู ูโุดููุฏ
- ฺฉูุชุงูโุณุงุฒ ูุจู ุงุฒ ุงุฑุณุงู ุจู API ุงูุฌุงู ูโุดูุฏ

**ฺฉุฏ:**
```javascript
const MAX_DIFF_SIZE = 500000; // 500KB default
if (diffText.length > MAX_DIFF_SIZE) {
    truncatedDiff = diffText.substring(0, MAX_DIFF_SIZE) + '\n... [diff truncated]';
}
```

### 7. ููุชุฑ ูุงูโูุง ุบุฑุถุฑูุฑ

**ูุดฺฉู:** ูุงูโูุง buildุ node_modules ู ุบุฑู ูุฒ ูพุฑุฏุงุฒุด ูโุดุฏูุฏ.

**ุฑุงูฺฉุงุฑ:**
- ูุงูโูุง `node_modules/`ุ `dist/`ุ `build/` ู `.git/` ููุชุฑ ูโุดููุฏ
- ูุงูโูุง auto-generated (`/generated/`, `*.generated.ts`) ฺฉุงููุงู ุญุฐู ูโุดููุฏ
- ูุงูโูุง ุชุฑุฌูู ุจู ุตูุฑุช ุฎุงุต ูุฏุฑุช ูโุดููุฏ (ููุชุฑ ูุจู ุงุฒ ุฎูุงูุฏู)

**ฺฉุฏ:**
```javascript
const shouldExcludeFile = (filePath) => {
    if (filePath.includes('/generated/') || 
        filePath.endsWith('.generated.ts') ||
        filePath.includes('node_modules/') || 
        filePath.includes('dist/') || 
        filePath.includes('build/') ||
        filePath.includes('.git/')) {
        return true;
    }
    return false;
}
```

## โ๏ธ ุชูุธูุงุช ูุงุจู ุชูุธู

ุชูุงู ุงู ูุญุฏูุฏุชโูุง ุงุฒ ุทุฑู ูุชุบุฑูุง ูุญุท ูุงุจู ุชูุธู ูุณุชูุฏ:

| ูุชุบุฑ | ูพุดโูุฑุถ | ุชูุถุญ |
|-------|---------|-------|
| `MAX_TOKENS_PER_REQUEST` | 180000 | ุญุฏุงฺฉุซุฑ ุชูฺฉู ุฏุฑ ูุฑ ุฏุฑุฎูุงุณุช (ุฒุฑ ุญุฏ 200k API) |
| `MAX_FILE_SIZE` | 30000 | ุญุฏุงฺฉุซุฑ ุงูุฏุงุฒู ูุงู (ฺฉุงุฑุงฺฉุชุฑ) |
| `MAX_FILES_TO_PROCESS` | 10 | ุญุฏุงฺฉุซุฑ ุชุนุฏุงุฏ ูุงู ุฏุฑ ูุฑ ุฏุฑุฎูุงุณุช |
| `MAX_DIFF_SIZE` | 500000 | ุญุฏุงฺฉุซุฑ ุงูุฏุงุฒู diff (ฺฉุงุฑุงฺฉุชุฑ) |
| `RETRY_MAX_ATTEMPTS` | 3 | ุชุนุฏุงุฏ ุชูุงุดโูุง ูุฌุฏุฏ |
| `RETRY_BASE_DELAY_MS` | 60000 | ุชุฃุฎุฑ ูพุงู ุจุฑุง retry (ููโุซุงูู) |

### ูุซุงู ุชูุธูุงุช ุฏุฑ `.env`:

```bash
# ุจุฑุง commitโูุง ุจุฒุฑฺฏุ ุชุนุฏุงุฏ ูุงูโูุง ุฑุง ฺฉุงูุด ุฏูุฏ
MAX_FILES_TO_PROCESS=8

# ุงฺฏุฑ ูููุฒ ุฎุทุง ูโฺฏุฑุฏุ ุชูฺฉู ุฑุง ุจุดุชุฑ ฺฉุงูุด ุฏูุฏ
MAX_TOKENS_PER_REQUEST=150000

# ุจุฑุง ูุงูโูุง ฺฉูฺฺฉุชุฑุ ุงูุฏุงุฒู ุฑุง ฺฉุงูุด ุฏูุฏ
MAX_FILE_SIZE=20000

# ุจุฑุง diffโูุง ุจุฒุฑฺฏุ ุงูุฏุงุฒู ุฑุง ฺฉุงูุด ุฏูุฏ
MAX_DIFF_SIZE=300000
```

## ๐ ูุชุงุฌ

ูพุณ ุงุฒ ุงุนูุงู ุงู ุชุบุฑุงุช:

โ **ูุงูโูุง ุจุฒุฑฺฏ ุจู ุตูุฑุช ุฎูุฏฺฉุงุฑ ฺฉูุชุงู ูโุดููุฏ**
- ูุงูโูุง ุชุฑุฌูู ููุท ููููู ฺฉูฺฺฉ ุงุฑุณุงู ูโุดููุฏ (ููุชุฑ ูุจู ุงุฒ ุฎูุงูุฏู)
- ูุงูโูุง ุจุฒุฑฺฏุชุฑ ุงุฒ 30KB ฺฉูุชุงู ูโุดููุฏ
- Diffโูุง ุจุฒุฑฺฏุชุฑ ุงุฒ 500KB ฺฉูุชุงู ูโุดููุฏ
- ูุงูโูุง auto-generated ฺฉุงููุงู ุญุฐู ูโุดููุฏ

โ **ุฏุฑ ุตูุฑุช ุฎุทุง rate limitุ retry ุฎูุฏฺฉุงุฑ ุงูุฌุงู ูโุดูุฏ**
- ุชุฃุฎุฑ ููุดููุฏุงูู ุจุง exponential backoff
- ุงุณุชูุงุฏู ุงุฒ `retry-after` header ุงุฒ API

โ **ููุท ูููโุชุฑู ูุงูโูุง ูพุฑุฏุงุฒุด ูโุดููุฏ**
- ูุงูโูุง ุฒุจุงู ูุจู ุงุฒ ุฎูุงูุฏู ููุชุฑ ูโุดููุฏ (16 ูุงู โ 2 ูุงู)
- ุญุฏุงฺฉุซุฑ 10 ูุงู ูพุฑุฏุงุฒุด ูโุดูุฏ
- ุงูููุช ุจุง ูุงูโูุง ฺฉุฏ ุงุณุช
- ูุงูโูุง ุชุฑุฌูู ุฏุฑ ุงูููุช ูพุงู

โ **ุชุนุฏุงุฏ ุชูฺฉู ูุจู ุงุฒ ุงุฑุณุงู ฺฉูุชุฑู ูโุดูุฏ**
- ุชุฎูู ุฏูู ูุจู ุงุฒ ุงุฑุณุงู
- ูุดุฏุงุฑ ุฏุฑ ุตูุฑุช ูุฒุฏฺฉ ุดุฏู ุจู ุญุฏ ูุฌุงุฒ
- ุฎุทุง ุฏุฑ ุตูุฑุช ูุฒุฏฺฉ ุดุฏู ุจู API hard limit (200k)

## ๐ง ูุญูู ุงุณุชูุงุฏู

1. **ุชูุธูุงุช ูพุดโูุฑุถ:** ุจุฏูู ุชุบุฑุ ฺฉุฏ ุจุง ุชูุธูุงุช ูพุดโูุฑุถ ฺฉุงุฑ ูโฺฉูุฏ
2. **ุชูุธูุงุช ุณูุงุฑุด:** ุฏุฑ ุตูุฑุช ูุงุฒุ ูุชุบุฑูุง ูุญุท ุฑุง ุฏุฑ `.env` ุชูุธู ฺฉูุฏ
3. **ูุงูุชูุฑูฺฏ:** ูุงฺฏโูุง ุชุฎูู ุชูฺฉู ุฑุง ููุงุด ูโุฏููุฏ

## ๐ ูุซุงู ูุงฺฏ

```
๐ Filtered 16 translation file(s) BEFORE reading - keeping only 1 sample per category (front/back)
๐ซ Excluded 1 auto-generated/build file(s)
๐ Estimated token usage: ~125000 tokens
๐ Selected 10 files for processing (skipped 6 files)
โ๏ธ Estimated tokens (175000) is within safe limit (180000)
```

## ๐จ ูฺฉุงุช ููู

1. **ูุงูโูุง ุชุฑุฌูู:** ููุท ฺฉ ููููู ุงุฒ ูุฑ category (front/back) ูพุฑุฏุงุฒุด ูโุดูุฏ. ุจูู ุจุงุฏ ุจู ุตูุฑุช ุฏุณุช ุจูโุฑูุฒุฑุณุงู ุดููุฏ
2. **API Hard Limit:** API ฺฉููุฏ ุญุฏุงฺฉุซุฑ 200,000 ุชูฺฉู ุฏุฑ ูุฑ ุฏุฑุฎูุงุณุช ูโูพุฐุฑุฏ. ุชูุธูุงุช ูพุดโูุฑุถ (180k) ุจุฑุง ุงุทููุงู ุฒุฑ ุงู ุญุฏ ุงุณุช
3. **Commitโูุง ุจุฒุฑฺฏ:** ุจุฑุง commitโูุง ุจุณุงุฑ ุจุฒุฑฺฏ (50+ ูุงู)ุ `MAX_FILES_TO_PROCESS` ุฑุง ุจู 8 ุง ฺฉูุชุฑ ฺฉุงูุด ุฏูุฏ
4. **ูุงูโูุง auto-generated:** ูุงูโูุง `/generated/` ู `*.generated.ts` ุจู ุตูุฑุช ุฎูุฏฺฉุงุฑ ุญุฐู ูโุดููุฏ

## ๐ ุจูุจูุฏูุง ุขูุฏู

- [ ] ูพุฑุฏุงุฒุด ุฏุณุชูโุง (batch processing) ุจุฑุง commitโูุง ุจุณุงุฑ ุจุฒุฑฺฏ
- [ ] ุงุณุชูุงุฏู ุงุฒ tokenizer ุฏููโุชุฑ ุจุฑุง ุชุฎูู ุชูฺฉู
- [ ] ฺฉุด ฺฉุฑุฏู ูุชุงุฌ ุจุฑุง ูุงูโูุง ูุดุงุจู
- [ ] ูพุดุชุจุงู ุงุฒ ูุงูโูุง ุจุงูุฑ

---

**ุชุงุฑุฎ ุงุฌุงุฏ:** 2025-12-10  
**ุขุฎุฑู ุจูโุฑูุฒุฑุณุงู:** 2025-12-10  
**ูุณุฎู:** 2.0.0

